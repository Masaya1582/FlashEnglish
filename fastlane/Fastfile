default_platform(:ios)

platform :ios do
  before_all do
    # Base64でエンコードされたGoogleService-Info.plistをデコードしてファイルとして書き出す
    if ENV['GOOGLE_SERVICE_INFO_PLIST_BASE64']
      File.write(
        './GoogleService-Info.plist',
        Base64.decode64(ENV['GOOGLE_SERVICE_INFO_PLIST_BASE64'])
      )
    else
      UI.error("GOOGLE_SERVICE_INFO_PLIST_BASE64 environment variable is not set!")
    end
  end

  desc "Push to Firebase App Distribution"
  lane :distribute_to_firebase do
    xcode_select("/Applications/Xcode.app")
    # 証明書の管理（match を使用している場合）
    match(type: "adhoc", readonly: true, git_url: "https://github.com/Masaya1582/ios-certificates")

    # ビルド
    build_app(
      scheme: "FlashEnglish", # アプリのスキームを指定
      export_method: "ad-hoc"  # ad-hoc 配布
    )

    # Firebase App Distribution へのアップロード
    firebase_app_distribution(
      app: ENV['FIREBASE_APP_ID'], # 環境変数からFirebase App IDを取得
      ipa_path: lane_context[SharedValues::IPA_OUTPUT_PATH], # IPAファイルのパス
      firebase_cli_token: ENV['FIREBASE_APP_DISTRIBUTION_API_TOKEN'], # Firebase CLI トークン
      groups: "all" # テスターグループを指定
    )
  end

  after_all do
    # ビルド後にGoogleService-Info.plistを削除する
    if File.exist?('./GoogleService-Info.plist')
      File.delete('./GoogleService-Info.plist')
    end
  end
end
