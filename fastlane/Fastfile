default_platform(:ios)

platform :ios do
  desc "Build and distribute app to Firebase"
  lane :distribute_to_firebase do
    # キーチェーンのセットアップ
    setup_keychain

    # AdHoc証明書の取得
    match(type: "adhoc", readonly: true) 

    # Xcodeのビルド
    build_app(scheme: "FlashEnglish")  

    # Firebase App Distributionへの配布
    firebase_app_distribution(
      app: "1:353282465583:ios:7879b5701a6426a9d1cbda",
      firebase_cli_token: ENV["FIREBASE_APP_DISTRIBUTION_API_TOKEN"],
      release_notes: "Automatic build from Develop branch",  
      testers: "masa4y44@gmail.com"  
    )
  end

  desc "Prepare GoogleService-Info.plist"
  lane :prepare_google_service_info do
    require 'base64'

    # GitHub SecretsからBase64エンコードされた文字列を取得
    plist_base64 = ENV['GOOGLE_SERVICE_INFO_PLIST_BASE64']

    # デコードしてファイルとして保存
    plist_data = Base64.decode64(plist_base64)

    # GoogleService-Info.plistを指定したディレクトリに作成
    File.open("./FlashEnglish/FlashEnglish/Resources/Firebase/GoogleService-Info.plist", "wb") do |f|
      f.write(plist_data)
    end

    UI.message("GoogleService-Info.plist has been created")
  end

  desc "Setup keychain"
  lane :setup_keychain do
    create_keychain(
      name: "login.keychain",  # ログインキーチェーンを使用
      default_keychain: true,
      unlock: true,
      timeout: 3600,
      password: ENV['KEYCHAIN_PASSWORD'] # GitHub Secretsで設定したキー
    )
  end
end