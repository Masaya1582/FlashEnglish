default_platform :ios

platform :ios do
  before_all do
    setup_circle_ci
  end

  desc "Upload Release to App Store"
  lane :upload_release do
    increment_build_number(
      build_number: app_store_build_number(
        initial_build_number: 1,
        version: get_version_number(
          workspace: "FlashEnglish.xcworkspace",
          scheme: "FlashEnglish"
        ),
        live: false
      ) + 1
    )
    match(type: "appstore")
    gym(scheme: "FlashEnglish")
    
    # Set up App Store Connect API key
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],        
      issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"], 
      key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY"]
    )

    deliver(
      submit_for_review: false,
      force: true
    )
  end

  desc "Upload to Testflight"
  lane :upload_testflight do
    increment_build_number(
      build_number: latest_testflight_build_number(
        initial_build_number: 1,
        version: get_version_number(
          workspace: "FlashEnglish.xcworkspace",
          scheme: "FlashEnglish"
        )
      ) + 1
    )
    
    # Set up Distribution code signing and build the app
    match(type: "appstore")
    gym(scheme: "FlashEnglish")
    
    # Set up App Store Connect API key
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],        
      issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"], 
      key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY"]
    )

    # Upload the binary to TestFlight and automatically publish
    # to the configured beta testing group
    pilot(
      distribute_external: true,
      notify_external_testers: true,
      groups: ["FlashEnglish Beta Testers"],
      changelog: "This is another new build from CircleCI!"
    )
  end

  desc "Upload to Firebase"
  lane :upload_firebase do
    increment_build_number(
      build_number: "$CIRCLE_BUILD_NUM"
    )
    match(type: "adhoc")
    gym(scheme: "FlashEnglish")
    firebase_app_distribution(
      app: "1:353282465583:ios:7879b5701a6426a9d1cbda",
      release_notes: "This is a test release!"
    )
  end
end