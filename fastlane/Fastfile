default_platform(:ios)

platform :ios do
  desc "Upload to Firebase"
  lane :distribute do
    match(type: "adhoc", readonly: true)

    # Increment build number
    increment_build_number

    # Fetch the new version and build number from Info.plist
    version_number = get_info_plist_value(path: "./FlashEnglish/Resources/Info.plist", key: "CFBundleShortVersionString")
    build_number = get_build_number

    gym(
      scheme: "FlashEnglish",
      verbose: true
    )
    
    firebase_app_distribution(
      app: "1:353282465583:ios:7879b5701a6426a9d1cbda",
      release_notes: "Beta Release: #{version_number} (Build: #{build_number})",
      firebase_cli_token: ENV["FIREBASE_APP_DISTRIBUTION_API_TOKEN"]
    )
  end

after_all do |lane|
    # Success message
    slack(
      message: "Successfully distributed build to Firebase App Distribution ðŸš€",
      slack_url: ENV["SLACK_WEBHOOK_URL"],
      channel: ENV["SLACK_CHANNEL_ID"]
    )
  end

  error do |lane, exception|
    # Failure message
    slack(
      message: "Failed to distribute build to Firebase App DistributionðŸ˜­",
      success: false,  # This marks the message as a failure
      slack_url: ENV["SLACK_WEBHOOK_URL"],
      channel: ENV["SLACK_CHANNEL_ID"]
    )
  end
end

