name: Distribute IPA to Firebase App Distribution

on:
  issue_comment:
    types: [created]

jobs:
  build:
    if: ${{ github.event.comment.body == 'distribute beta' }}
    runs-on: macos-latest  # Use latest macOS environment for the job

    steps:
    - name: Send comment back to PR
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          github.rest.issues.createComment({
            issue_number: context.payload.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: "Beta版アプリを配信します 🚀"
          })

    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'

    - name: Set Xcode version
      run: |
        sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
        sudo xcodebuild -runFirstLaunch

    - name: Cache CocoaPods
      uses: actions/cache@v2
      with:
        path: Pods
        key: ${{ runner.os }}-pods-${{ hashFiles('Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-

    - name: Install CocoaPods
      run: |
        gem install bundler
        bundle install
        pod install

    - name: Decrypt GoogleService-Info.plist
      run: |
        mkdir -p FlashEnglish/Resources/Firebase
        echo "$GOOGLE_SERVICE_INFO_PLIST_BASE64" | base64 --decode > FlashEnglish/Resources/Firebase/GoogleService-Info.plist
      env:
        GOOGLE_SERVICE_INFO_PLIST_BASE64: ${{ secrets.GOOGLE_SERVICE_INFO_PLIST_BASE64 }}

    - name: Decrypt and Import .p12 Certificate
      run: |
        echo "$P12_BASE64" | base64 --decode > certificate.p12
        security create-keychain -p "" build.keychain
        security list-keychains -s build.keychain
        security unlock-keychain -p "" build.keychain
        security import ./certificate.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain
      env:
        P12_BASE64: ${{ secrets.P12_BASE64 }}
        P12_PASSWORD: ${{ secrets.MATCH_PASSWORD }}

    - name: Set up Fastlane
      run: bundle exec fastlane match adhoc --readonly
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}

    - name: Enable Parallel Code Signing
      run: |
        defaults write com.apple.dt.Xcode IDEBuildOperationMaxNumberOfConcurrentCompileTasks 4

    - name: Build and distribute to Firebase App Distribution
      run: bundle exec fastlane distribute
      env:
        FIREBASE_APP_DISTRIBUTION_API_TOKEN: ${{ secrets.FIREBASE_APP_DISTRIBUTION_API_TOKEN }}
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        FASTLANE_USER: ${{ secrets.FASTLANE_USER }}
        FASTLANE_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}

    # Uncomment these for Slack notifications if needed
    # - name: Notify Slack on Success
    #   if: success()
    #   uses: rtCamp/action-slack-notify@v2
    #   env:
    #     SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
    #     SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL_ID }}
    #     SLACK_TITLE: "Build Successful!"
    #     SLACK_MESSAGE: "Successfully distributed build to Firebase App Distribution 🚀"
    #     SLACK_COLOR: "good"

    # - name: Notify Slack on Failure
    #   if: failure()
    #   uses: rtCamp/action-slack-notify@v2
    #   env:
    #     SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
    #     SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL_ID }}
    #     SLACK_TITLE: "Build Failed!"
    #     SLACK_MESSAGE: "Failed to distribute build to Firebase App Distribution😭"
    #     SLACK_COLOR: "danger"
