name: Distribute IPA to Firebase App Distribution

on:
  push:
    branches:
      - develop  # developãƒ–ãƒ©ãƒ³ãƒã«pushã•ã‚ŒãŸã¨ãã«ã“ã®ã‚¸ãƒ§ãƒ–ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹

jobs:
  build:
    runs-on: macos-latest  # æœ€æ–°ã®macOSç’°å¢ƒã§ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œ

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2  # ãƒªãƒã‚¸ãƒˆãƒªã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'  # Rubyã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³3.2ã‚’è¨­å®šã€‚Fastlaneã‚„CocoaPodsã¯Rubyã§å‹•ä½œã™ã‚‹ãŸã‚

    - name: Set Xcode version
      run: |
        sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
        sudo xcodebuild -runFirstLaunch

    - name: Cache CocoaPods
      uses: actions/cache@v2
      with:
        path: Pods  # CocoaPodsã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        key: ${{ runner.os }}-pods-${{ hashFiles('Podfile.lock') }}  # Podfile.lockã‚’åŸºã«ã—ãŸã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼
        restore-keys: |
          ${{ runner.os }}-pods-  # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚­ãƒ¼

    - name: Install CocoaPods
      run: |
        gem install bundler
        bundle install
        pod install

    - name: Decrypt GoogleService-Info.plist
      run: |
        mkdir -p FlashEnglish/Resources/Firebase
        echo "$GOOGLE_SERVICE_INFO_PLIST_BASE64" | base64 --decode > FlashEnglish/Resources/Firebase/GoogleService-Info.plist
      env:
        GOOGLE_SERVICE_INFO_PLIST_BASE64: ${{ secrets.GOOGLE_SERVICE_INFO_PLIST_BASE64 }}  # Firebaseç”¨ã®GoogleService-Info.plistã‚’Secretsã‹ã‚‰å¾©å·åŒ–ã—ã¦é…ç½®

    - name: Decrypt and Import .p12 Certificate
      run: |
        echo "$P12_BASE64" | base64 --decode > certificate.p12
        security create-keychain -p "" build.keychain
        security list-keychains -s build.keychain
        security unlock-keychain -p "" build.keychain
        security import ./certificate.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain
      env:
        P12_BASE64: ${{ secrets.P12_BASE64 }}  # Secretsã«ä¿å­˜ã—ãŸè¨¼æ˜æ›¸ã®Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰å€¤
        P12_PASSWORD: ${{ secrets.MATCH_PASSWORD }}  # è¨¼æ˜æ›¸ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’Secretsã‹ã‚‰å–å¾—

    - name: Set up Fastlane
      run: bundle exec fastlane match adhoc --readonly  # Fastlaneã®Matchã‚’ä½¿ç”¨ã—ã¦AdHocãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ãƒ¢ãƒ¼ãƒ‰ï¼‰
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}  # Matchç”¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰

    - name: Enable Parallel Code Signing
      run: |
        defaults write com.apple.dt.Xcode IDEBuildOperationMaxNumberOfConcurrentCompileTasks 4  # Xcodeã§ä¸¦åˆ—ã‚³ãƒ¼ãƒ‰ç½²åã‚’æœ‰åŠ¹åŒ–ã—ã€ãƒ“ãƒ«ãƒ‰æ™‚é–“ã‚’çŸ­ç¸®

    - name: Build and distribute to Firebase App Distribution
      run: bundle exec fastlane distribute  # Fastlaneã§ã‚¢ãƒ—ãƒªã‚’ãƒ“ãƒ«ãƒ‰ã—ã€Firebase App Distributionã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      env:
        FIREBASE_APP_DISTRIBUTION_API_TOKEN: ${{ secrets.FIREBASE_APP_DISTRIBUTION_API_TOKEN }}  # Firebase App Distributionç”¨ã®APIãƒˆãƒ¼ã‚¯ãƒ³
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}  # Matchç”¨ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
        FASTLANE_USER: ${{ secrets.FASTLANE_USER }}  # Fastlaneã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆApple IDãªã©ï¼‰
        FASTLANE_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}  # Fastlaneã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰

    # Slack notification on success
    - name: Notify Slack on Success
      if: success()
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL_ID }}
        SLACK_TITLE: "Build Successful!"
        SLACK_MESSAGE: "Successfully distributed build to Firebase App Distribution ğŸš€"
        SLACK_COLOR: "good"

    # Slack notification on failure
    - name: Notify Slack on Failure
      if: failure()
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        SLACK_CHANNEL: ${{ secrets.SLACK_CHANNEL_ID }}
        SLACK_TITLE: "Build Failed!"
        SLACK_MESSAGE: "Failed to distribute build to Firebase App DistributionğŸ˜­"
        SLACK_COLOR: "danger"
