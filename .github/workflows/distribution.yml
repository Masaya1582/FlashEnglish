name: Distribute IPA to Firebase App Distribution

on:
  push:
    branches:
      - develop  # Trigger the job when pushing to the develop branch

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2  # Checkout the repository source code

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'  # Use Ruby version 3.2, required for Fastlane and CocoaPods

    - name: Set Xcode version
      run: |
        sudo xcode-select -s /Applications/Xcode.app/Contents/Developer
        sudo xcodebuild -runFirstLaunch

    - name: Cache CocoaPods
      uses: actions/cache@v2
      with:
        path: Pods  # Cache installed CocoaPods dependencies
        key: ${{ runner.os }}-pods-${{ hashFiles('Podfile.lock') }}  # Cache key based on Podfile.lock
        restore-keys: |
          ${{ runner.os }}-pods-  # Fallback cache key if the main one isn't found

    - name: Install CocoaPods
      run: |
        gem install bundler
        bundle install
        pod install

    - name: Decrypt GoogleService-Info.plist
      run: |
        mkdir -p FlashEnglish/Resources/Firebase
        echo "$GOOGLE_SERVICE_INFO_PLIST_BASE64" | base64 --decode > FlashEnglish/Resources/Firebase/GoogleService-Info.plist
      env:
        GOOGLE_SERVICE_INFO_PLIST_BASE64: ${{ secrets.GOOGLE_SERVICE_INFO_PLIST_BASE64 }}  # Decrypt the GoogleService-Info.plist for Firebase from secrets

    - name: Decrypt and Import .p12 Certificate
      run: |
        echo "$P12_BASE64" | base64 --decode > certificate.p12
        security create-keychain -p "" build.keychain
        security list-keychains -s build.keychain
        security unlock-keychain -p "" build.keychain
        security import ./certificate.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "" build.keychain
      env:
        P12_BASE64: ${{ secrets.P12_BASE64 }}  # The Base64 encoded certificate
        P12_PASSWORD: ${{ secrets.MATCH_PASSWORD }}  # Password for the certificate from secrets

    - name: Set up Fastlane
      run: bundle exec fastlane match adhoc --readonly  # Use Fastlane Match to get the AdHoc profile (read-only mode)
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}  # Match password from secrets

    - name: Enable Parallel Code Signing
      run: |
        defaults write com.apple.dt.Xcode IDEBuildOperationMaxNumberOfConcurrentCompileTasks 4  # Enable parallel code signing to speed up builds

    - name: Build and distribute to Firebase App Distribution
      run: bundle exec fastlane distribute  # Use Fastlane to build the app and upload it to Firebase App Distribution
      env:
        FIREBASE_APP_ID: ${{ secrets.FIREBASE_APP_ID }}
        FIREBASE_APP_DISTRIBUTION_API_TOKEN: ${{ secrets.FIREBASE_APP_DISTRIBUTION_API_TOKEN }}  # Firebase App Distribution API token
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}  # Match password from secrets
        FASTLANE_USER: ${{ secrets.FASTLANE_USER }}  # Fastlane user (Apple ID, etc.)
        FASTLANE_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}  # Fastlane password

  notify:
    runs-on: ubuntu-latest  # Slack通知はUbuntuランナーを使用
    needs: build  # buildジョブの成功/失敗に依存
    steps:
    - name: Slack Notification on Success
      if: ${{ needs.build.result == 'success' }}
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}  # Webhook URL stored in GitHub secrets
        SLACK_TITLE: "Deploy / Success"
        SLACK_COLOR: good
        SLACK_MESSAGE: "Successfully distributed build to Firebase App Distribution :rocket:"

    - name: Slack Notification on Failure
      if: ${{ needs.build.result == 'failure' }}
      uses: rtCamp/action-slack-notify@v2
      env:
        SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}  # Webhook URL stored in GitHub secrets
        SLACK_TITLE: "Deploy / Failure"
        SLACK_COLOR: danger
        SLACK_MESSAGE: "Failed to distribute build to Firebase App Distribution :sob:"
