name: Swift

on:
  push:
    branches:
      - develop

jobs:
  build:
    runs-on: macOS-latest

    steps:
    - uses: actions/checkout@v1

    - name: ブランチ名を取得
      id: extract_branch
      run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"

    - name: Rubyのバージョンを表示
      run: ruby -v

    - name: 環境変数をBASE64デコードして証明書を復元
      env:
        CERTIFICATES: ${{ secrets.CERTIFICATES }}
      run: echo $CERTIFICATES | base64 --decode > apple-distribution-mycompany-inc.p12

    - name: プロビジョニングプロファイルを格納するディレクトリーを作成
      run: mkdir -pv ~/Library/MobileDevice/Provisioning\ Profiles/

    - name: 環境変数をBASE64デコードしてプロビジョニングプロファイルを復元
      env:
        PROVISIONING_PROFILES: ${{ secrets.PROVISIONING_PROFILES }}
      run: echo $PROVISIONING_PROFILES | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/${{ secrets.PROVISIONING_PROFILE_NAME }}.mobileprovision

    - name: CocoaPodsのセットアップ
      run: pod install

    - name: Xcodeプロジェクトのビルド
      env:
        CODE_SIGN_IDENTITY: ${{ secrets.CODE_SIGN_IDENTITY }}
        PROVISIONING_PROFILE_SPECIFIER: ${{ secrets.PROVISIONING_PROFILE_SPECIFIER }}
      run: |
        xcodebuild -workspace YourProject.xcworkspace \
          -scheme ${{ secrets.SCHEME_NAME }} \
          -sdk iphoneos \
          -configuration Release \
          -archivePath $PWD/build/FlashEnglish.xcarchive \
          clean archive \
          CODE_SIGN_IDENTITY="${{ secrets.CODE_SIGN_IDENTITY }}" \
          PROVISIONING_PROFILE_SPECIFIER="${{ secrets.PROVISIONING_PROFILE_SPECIFIER }}"

    - name: IPAのエクスポート
      run: |
        xcodebuild -exportArchive \
          -archivePath $PWD/build/FlashEnglish.xcarchive \
          -exportPath $PWD/build/FlashEnglish.ipa \
          -exportOptionsPlist ${{ secrets.PLIST_PATH }}

    - name: Firebase Toolsをインストール
      run: npm install -g firebase-tools

    - name: Firebase App Distributionへアップロード
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
      run: |
        firebase appdistribution:distribute $PWD/build/FlashEnglish.ipa \
          --app ${{ secrets.FIREBASE_APP_ID }} \
          --testers ${{ secrets.FIREBASE_TESTERS }}
